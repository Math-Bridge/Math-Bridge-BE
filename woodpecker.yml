when:
  - event: pull_request
    branch: paymentSepay
  - event: push
    branch: paymentSepay
    
steps:
  - name: Building BE
    image: bash
    environment:
      # Make Woodpecker secrets available as environment variables in this step
      SSHK:
        from_secret: SSH_KEY
      REMOTE_HOST: 192.168.2.245
      REMOTE_USER: root
      REMOTE_TARGET_PATH: /root # e.g., /var/www/myapp
    commands:
      - wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh | bash
      - chmod +x ./dotnet-install.sh
      - ./dotnet-install.sh --version latest
      - export PATH=$PATH:$HOME/.dotnet
      - dotnet publish -c Release -o ./publish
      - ls
      - sudo apt-get update -y && sudo apt-get install -y openssh-client rsync
      
      # Setup SSH
      - sudo mkdir -p $WOODPECKER_WORKSPACE/.ssh
      - echo "$SSHK" | sudo tee $WOODPECKER_WORKSPACE/.ssh/id_rsa_deploy > /dev/null
      - sudo chmod 700 $WOODPECKER_WORKSPACE/.ssh/id_rsa_deploy
      - ssh-keyscan -H $REMOTE_HOST | sudo tee -a $WOODPECKER_WORKSPACE/.ssh/known_hosts > /dev/null
      # Create target directory
      - sudo ssh -i $WOODPECKER_WORKSPACE/.ssh/id_rsa_deploy -o StrictHostKeyChecking=no $REMOTE_USER@$REMOTE_HOST "sudo mkdir -p $REMOTE_TARGET_PATH/MathBridge_BE"
      # Copy files using rsync (better than scp for directories)
      - sudo rsync -avWL -e "ssh -i $WOODPECKER_WORKSPACE/.ssh/id_rsa_deploy -o StrictHostKeyChecking=no" ./publish/ "$REMOTE_USER@$REMOTE_HOST:$REMOTE_TARGET_PATH/MathBridge_BE"
      - |
        sudo ssh -i $WOODPECKER_WORKSPACE/.ssh/id_rsa_deploy -o StrictHostKeyChecking=no $REMOTE_USER@$REMOTE_HOST "
          cd $REMOTE_TARGET_PATH/MathBridge_BE &&
          pkill -f 'dotnet.*MathBridgeSystem\.Api\.dll' || true &&
          sleep 3 &&
          pkill -9 -f 'dotnet.*MathBridgeSystem\.Api\.dll' || true &&
          sleep 1 &&
          export ASPNETCORE_ENVIRONMENT=Development &&
          nohup dotnet MathBridgeSystem.Api.dll --urls='http://0.0.0.0:5000' > app.log 2>&1 &
        "
